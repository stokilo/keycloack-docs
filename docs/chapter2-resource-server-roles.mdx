---
sidebar_label: 'Resource Server Roles'
sidebar_position: 102
---

import ImageCarousel from './components/ImageCarousel';
import ShikiCodeBlock from './components/ShikiCodeBlock';
import Highlight from './components/Highlight';

# Resouce Server With Roles

**Chapter 2**

Extension of Resource Server

[chapter1-resource-server](chapter1-resource-server)

but now with roles.

**Create Realm Roles**

Create Realm Roles:

Realm roles are **global to the realm** and **can be assigned to any user**.

| Role name   |
| -------- |
| APP_USER   |
| APP_ADMIN  |

<ImageCarousel
  images={[
    { imageUrl: '/img/chapter2/screenshot_112n7cPJ5.png' },
    { imageUrl: '/img/chapter2/screenshot_229oH2ud3.png' },
    { imageUrl: '/img/chapter2/screenshot_33VkrSUSs.png' },
  ]} />

Add assign to the existing **testuser**

<ImageCarousel
  images={[
    { imageUrl: '/img/chapter2/screenshot_11WBpbtsMc.png'},
    { imageUrl: '/img/chapter2/screenshot_22U7QmO3Yb.png' },
    { imageUrl: '/img/chapter2/screenshot_33LlQEZnuh.png' },
    { imageUrl: '/img/chapter2/screenshot_44E64SYD6V.png' },
  ]} />

**Map Realm Roles into the Access Token**

By default, realm roles are not automatically included in the access token. We need to add a mapper to our client or a client scope.

<ImageCarousel
  images={[
    { imageUrl: '/img/chapter2/screenshot_11ofhTmq3.png'},
    { imageUrl: '/img/chapter2/screenshot_22wBE7B2q.png'},
    { imageUrl: '/img/chapter2/screenshot_33GFXL3rh.png'},
    { imageUrl: '/img/chapter2/screenshot_447hGyxz0.png'},
    { imageUrl: '/img/chapter2/screenshot_551LlMYaB.png'},
    { imageUrl: '/img/chapter2/screenshot_66ah4Bcul.png'},
  ]} />

| Setting                | Value / Description                                                                                                                                      |
|------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Name**               | Realm Roles Mapper (or any descriptive name)                                                                                                             |
| **Realm Role prefix**  | *(Leave blank if you don't want a prefix in the token; add `ROLE_` in Spring. You could put `ROLE_` here, but it's more conventional to handle it in Spring.)* |
| **Token Claim Name**   | `realm_access.roles` (common convention; `realm_access` is an object in the JWT, and `roles` is an array within it)                                      |
| **Multivalued**        | ✅ ON (a user can have multiple roles)                                                                                                                   |
| **Add to ID token**    | ❌ OFF (typically not needed for resource server authorization)                                                                                           |
| **Add to access token**| ✅ ON (essential for the resource server)                                                                                                                 |
| **Add to userinfo**    | ❌ OFF (typically not needed for resource server authorization)                                                                                           |

**Spring Security**

Keycloak is now configured to **issue tokens that include realm roles**.


<ShikiCodeBlock language="java" theme="catppuccin-frappe"
                source="https://raw.githubusercontent.com/stokilo/keycloack-docs/refs/heads/main/chapters/chapter2-resource-server-roles/src/main/java/org/sstec/resourceserver/SecurityConfig.java" />



**Application properties**

<ShikiCodeBlock language="properties" theme="catppuccin-frappe"
                source="https://raw.githubusercontent.com/stokilo/keycloack-docs/refs/heads/main/chapters/chapter2-resource-server-roles/src/main/resources/application.properties" />

**Failed attempt to get authorities from claim**

With current configuration when you attempt to call public endpoint you fill get empty array with authorities.

<ImageCarousel
  images={[
    { imageUrl: '/img/chapter2/screenshot_11vJgxQRb.png'},
    { imageUrl: '/img/chapter2/screenshot_223OAzyEu.png'},
    { imageUrl: '/img/chapter2/screenshot_33QEsh8BBm.png'},
  ]} />

This is caused by the nested structure of the claim **realm_access.roles**
Spring will parse this as a LinkedList with key **realm_access** and **roles** as value.
However, **grantedAuthoritiesConverter.setAuthoritiesClaimName("realm_access.roles");** is expecting
claim with key **realm_access.roles**

Keycloak allows to send claim with **realm_access.roles** but you need to set value of the claim to **realm_access\\.roles**

What it does is really **duplicating** claim and you will have two claims with same values

| Claim name   | Value |
| -------- | -------- |
| role_access.roles  | ["APP_ADMIN", "APP_USER", ....] |
| role_access  | roles: ["APP_ADMIN", "APP_USER"] |

<ImageCarousel
  images={[
    { imageUrl: '/img/chapter2/screenshot_11ztoo2hl.png'},
    { imageUrl: '/img/chapter2/screenshot_33rfDZwKH.png'},
  ]} />

After the change, this fix Spring JwtAuthenticationConverter claims mapping.

Note **prefix** from Spring configuration, **ROLE_** is appended to the authorities.
This allows standard spring role checks mechanism work in standard way.

import ImageGallery from 'react-image-gallery'
import "react-image-gallery/styles/css/image-gallery.css"

<ImageGallery items={
  [
    { original: "/img/chapter2/screenshot_11MFlJjydq.png" },
    { original: "/img/chapter2/screenshot_33rfDZwKH.png" },
    { original: "/img/chapter2/screenshot_11ztoo2hl.png" },
  ]
} />









